// src/app/admin/clients/[clientId]/payment-history/page.jsx
"use client";
import LoadingSkeleton from "@/src/loader/LoadingSkeleton";
import { fetchEnterpriseClientPaymentHistory } from "@/src/redux/features/enterprise/client/clientThunks";
import { useParams } from "next/navigation";
import { useEffect, useState } from "react";
import {
  FiAlertCircle,
  FiAlertTriangle,
  FiArrowLeft,
  FiCalendar,
  FiCheckCircle,
  FiClock,
  FiCreditCard,
  FiDatabase,
  FiDollarSign,
  FiDownload,
  FiFileText,
  FiImage,
  FiLayers,
  FiPackage,
  FiRefreshCw,
  FiShoppingCart,
  FiTrendingUp,
  FiUsers,
  FiXCircle,
} from "react-icons/fi";
import { useDispatch, useSelector } from "react-redux";

export default function ClientPaymentHistory() {
  const dispatch = useDispatch();
  const { id } = useParams();
  const { clientPaymentHistory, loading } = useSelector(
    (state) => state.enterpriseClient
  );

  const [selectedPayment, setSelectedPayment] = useState(null);
  const [showModal, setShowModal] = useState(false);

  useEffect(() => {
    if (id && !clientPaymentHistory) {
      dispatch(fetchEnterpriseClientPaymentHistory({ id }));
    }
  }, [dispatch, id, clientPaymentHistory]);

  const openPaymentDetails = (payment) => {
    setSelectedPayment(payment);
    setShowModal(true);
  };

  if (loading) return <LoadingSkeleton />;
  if (!clientPaymentHistory)
    return <ErrorState message="Error loading payment history" />;

  const { actionBreakdown, timeline } = clientPaymentHistory;

  // ✅ Calculate stats on client-side
  const stats = calculateStats(timeline);
  return (
    <div className="min-h-screen">
      {/* Stats Overview - 2 Rows */}
      <div className="space-y-4 mb-6">
        {/* Row 1: Main Metrics */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <StatsCard
            label="Total Transactions"
            value={stats.totalTransactions}
            icon={<FiFileText className="w-5 h-5" />}
            color="blue"
          />
          <StatsCard
            label="INR Revenue"
            value={`₹${formatNumber(stats.INR.totalAmountPaid)}`}
            icon={<FiDollarSign className="w-5 h-5" />}
            color="green"
            subtitle={`${stats.INR.count} transactions`}
          />
          <StatsCard
            label="USD Revenue"
            value={`$${formatNumber(stats.USD.totalAmountPaid)}`}
            icon={<FiDollarSign className="w-5 h-5" />}
            color="green"
            subtitle={`${stats.USD.count} transactions`}
          />
          <StatsCard
            label="Payment Status"
            value={stats.successfulPayments}
            icon={<FiCheckCircle className="w-5 h-5" />}
            color="green"
            subtitle={`Failed: ${stats.failedPayments} | Pending: ${stats.pendingPayments}`}
          />
        </div>

        {/* Row 2: Financial Breakdown */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <StatsCard
            label="Total Discounts"
            value={
              <span className="space-y-1">
                <span className="text-sm">
                  ₹{formatNumber(stats.INR.totalDiscounts)}
                </span>
                <span className="text-sm">
                  ${formatNumber(stats.USD.totalDiscounts)}
                </span>
              </span>
            }
            icon={<FiDollarSign className="w-5 h-5" />}
            color="orange"
            subtitle="INR / USD"
          />
          <StatsCard
            label="Credit Applied"
            value={
              <span className="space-y-1">
                <span className="text-sm">
                  ₹{formatNumber(stats.INR.totalCreditApplied)}
                </span>
                <span className="text-sm">
                  ${formatNumber(stats.USD.totalCreditApplied)}
                </span>
              </span>
            }
            icon={<FiRefreshCw className="w-5 h-5" />}
            color="blue"
            subtitle="INR / USD"
          />
          <StatsCard
            label="Total Profit"
            value={
              <span className="space-y-1">
                <span className="text-sm">
                  ₹{formatNumber(stats.INR.totalCreditLost)}
                </span>
                <span className="text-sm">
                  ${formatNumber(stats.USD.totalCreditLost)}
                </span>
              </span>
            }
            icon={<FiTrendingUp className="w-5 h-5" />}
            color="purple"
            subtitle="Credit Lost"
          />
          <StatsCard
            label="Razorpay Fees (INR)"
            value={`₹${formatNumber(
              stats.INR.totalRazorpayFees + stats.USD.totalRazorpayFees
            )}`}
            icon={<FiCreditCard className="w-5 h-5" />}
            color="orange"
            subtitle={`GST: ₹${formatNumber(
              stats.INR.totalRazorpayTax + stats.USD.totalRazorpayTax
            )}`}
          />
        </div>
      </div>

      {/* Action Breakdown */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
        <h2 className="text-lg font-semibold text-[#343148] mb-4">
          Action Breakdown
        </h2>
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
          <ActionBadge
            label="Trial"
            count={actionBreakdown.trial}
            icon={<FiClock />}
            color="gray"
          />
          <ActionBadge
            label="Purchase"
            count={actionBreakdown.purchase}
            icon={<FiShoppingCart />}
            color="blue"
          />
          <ActionBadge
            label="Upgrade"
            count={actionBreakdown.upgrade}
            icon={<FiTrendingUp />}
            color="purple"
          />
          <ActionBadge
            label="Renewal"
            count={actionBreakdown.renewal}
            icon={<FiRefreshCw />}
            color="green"
          />
          <ActionBadge
            label="Expired"
            count={actionBreakdown.expired}
            icon={<FiAlertCircle />}
            color="red"
          />
        </div>
      </div>

      {/* Timeline View */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 className="text-lg font-semibold text-[#343148] mb-6">
          Transaction Timeline
        </h2>

        <div className="relative">
          {/* Timeline Line */}
          <div className="absolute left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-[#343148] via-[#D7C39D] to-gray-200" />

          {timeline.map((period, periodIdx) => (
            <div key={periodIdx} className="mb-8 last:mb-0">
              {/* Month Header */}
              <div className="flex items-center gap-4 mb-4 relative">
                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-[#343148] to-[#D7C39D] flex items-center justify-center text-white font-bold shadow-lg z-10">
                  <div className="text-center">
                    <div className="text-xs">{period.month.slice(0, 3)}</div>
                    <div className="text-sm">{period.year}</div>
                  </div>
                </div>
                <div className="text-sm text-gray-500">
                  {period.payments.length} transaction
                  {period.payments.length > 1 ? "s" : ""}
                </div>
              </div>

              {/* Payment Cards */}
              <div className="ml-24 space-y-4">
                {period.payments.map((payment, payIdx) => (
                  <PaymentCard
                    key={payIdx}
                    payment={payment}
                    onClick={() => openPaymentDetails(payment)}
                  />
                ))}
              </div>
            </div>
          ))}

          {timeline.length === 0 && (
            <div className="text-center py-12">
              <FiFileText className="w-16 h-16 text-gray-300 mx-auto mb-4" />
              <p className="text-gray-500">No payment history found</p>
            </div>
          )}
        </div>
      </div>

      {/* Payment Details Modal */}
      {showModal && selectedPayment && (
        <PaymentDetailsModal
          payment={selectedPayment}
          onClose={() => setShowModal(false)}
        />
      )}
    </div>
  );
}

// ============ COMPONENTS ============

const StatsCard = ({ label, value, icon, color, subtitle }) => {
  const colorClasses = {
    blue: "from-blue-500 to-blue-600",
    green: "from-green-500 to-green-600",
    orange: "from-orange-500 to-orange-600",
    purple: "from-purple-500 to-purple-600",
  };

  return (
    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all">
      <div className="flex items-center gap-3 mb-2">
        <div
          className={`w-10 h-10 rounded-lg bg-gradient-to-br ${colorClasses[color]} flex items-center justify-center text-white`}
        >
          {icon}
        </div>
        <div className="flex-1">
          <p className="text-xs text-gray-600 font-medium">{label}</p>
          <p className="text-xl font-bold text-[#343148]">{value}</p>
        </div>
      </div>
      {subtitle && (
        <p className="text-xs text-gray-500 mt-1 ml-13">{subtitle}</p>
      )}
    </div>
  );
};

const ActionBadge = ({ label, count, icon, color }) => {
  const colorClasses = {
    blue: "bg-blue-50 text-blue-700 border-blue-200",
    green: "bg-green-50 text-green-700 border-green-200",
    purple: "bg-purple-50 text-purple-700 border-purple-200",
    orange: "bg-orange-50 text-orange-700 border-orange-200",
    gray: "bg-gray-50 text-gray-700 border-gray-200",
  };

  return (
    <div
      className={`${colorClasses[color]} border rounded-lg p-3 flex items-center gap-2`}
    >
      <div className="text-lg">{icon}</div>
      <div>
        <p className="text-xs font-medium opacity-80">{label}</p>
        <p className="text-lg font-bold">{count}</p>
      </div>
    </div>
  );
};

const PaymentCard = ({ payment, onClick }) => {
  const { paymentDetails, packageId, action, usageAtAction } = payment;
  const statusConfig = getPaymentStatusConfig(paymentDetails.paymentStatus);
  const actionConfig = getActionConfig(action);

  // ✅ Get currency symbol dynamically
  const currencySymbol =
    paymentDetails.symbol || (paymentDetails.currency === "INR" ? "₹" : "$");
  const currency = paymentDetails.currency || "USD";
  return (
    <div
      onClick={onClick}
      className="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg hover:border-[#D7C39D] transition-all cursor-pointer group"
    >
      <div className="flex flex-wrap items-start justify-between gap-4 mb-4">
        {/* Left Section */}
        <div className="flex items-start gap-3 flex-1">
          <div
            className={`w-12 h-12 rounded-lg ${actionConfig.bgColor} flex items-center justify-center text-white flex-shrink-0`}
          >
            {actionConfig.icon}
          </div>
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-1">
              <h3 className="text-base font-semibold text-[#343148] truncate">
                {packageId?.packageName || "Package"}
              </h3>
              <span
                className={`px-2 py-0.5 rounded-full text-xs font-medium ${actionConfig.badgeColor}`}
              >
                {action.toUpperCase()}
              </span>
            </div>
            <p className="text-xs text-gray-500">
              {formatDate(payment.createdAt)} • {formatTime(payment.createdAt)}
            </p>
          </div>
        </div>

        {/* Right Section - Amount with Dynamic Currency */}
        <div className="text-right">
          <p className="text-2xl font-bold text-[#343148]">
            {currencySymbol}
            {formatNumber(paymentDetails.amountPaid || 0)}
          </p>
          <p className="text-xs text-gray-500 font-medium mb-1">{currency}</p>
        </div>
      </div>

      {/* Payment Details Grid */}
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <DetailItem
          icon={<FiCalendar />}
          label="Duration"
          value={`${calculateDuration(
            payment.startDate,
            payment.endDate
          )} days`}
        />
        <DetailItem
          icon={<FiFileText />}
          label="Invoice"
          value={paymentDetails.invoiceNumber || "N/A"}
        />
        <DetailItem
          icon={<FiClock />}
          label="Payment"
          value={paymentDetails.paymentMethod || "N/A"}
        />
        <DetailItem
          icon={statusConfig.icon}
          label="Status"
          value={
            <span className={`font-medium ${statusConfig.textColor}`}>
              {paymentDetails.paymentStatus}
            </span>
          }
        />
      </div>

      {/* Usage Stats */}
      {usageAtAction && (
        <div className="bg-gray-50 rounded-lg p-3">
          <p className="text-xs font-semibold text-gray-600 mb-2">
            Usage at Transaction
          </p>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <UsageItem
              icon={<FiCalendar />}
              label="Events"
              value={usageAtAction.totalEvents || 0}
            />
            <UsageItem
              icon={<FiLayers />}
              label="Albums"
              value={usageAtAction.totalAlbums || 0}
            />
            <UsageItem
              icon={<FiImage />}
              label="Photos"
              value={formatNumber(usageAtAction.totalPhotos || 0)}
            />
            <UsageItem
              icon={<FiDatabase />}
              label="Storage"
              value={`${((usageAtAction.totalMBUsed || 0) / 1024).toFixed(
                1
              )} GB`}
            />
          </div>
        </div>
      )}

      {/* Hover Effect Indicator */}
      <div className="mt-3 flex items-center justify-between text-xs text-gray-400 group-hover:text-[#D7C39D] transition-colors">
        <span>Click to view full details</span>
        <FiArrowLeft className="rotate-180" />
      </div>
    </div>
  );
};

const DetailItem = ({ icon, label, value }) => (
  <div className="flex items-center gap-2">
    <div className="text-gray-400">{icon}</div>
    <div>
      <p className="text-xs text-gray-500">{label}</p>
      <p className="text-sm font-medium text-gray-900">{value}</p>
    </div>
  </div>
);

const UsageItem = ({ icon, label, value }) => (
  <div className="flex items-center gap-2">
    <div className="text-[#343148] text-sm">{icon}</div>
    <div>
      <p className="text-xs text-gray-600">{label}</p>
      <p className="text-sm font-bold text-[#343148]">{value}</p>
    </div>
  </div>
);

const PaymentDetailsModal = ({ payment, onClose }) => {
  const { paymentDetails, packageDetails, packageId, previousPackageId } =
    payment;

  return (
    <div
      className="fixed inset-0 bg-black/50 bg-opacity-50 flex items-center justify-center z-50 p-4"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="sticky top-0 bg-gradient-to-r from-[#343148] to-[#D7C39D] text-white p-6 rounded-t-2xl">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold">Payment Details</h2>
              <p className="text-sm opacity-90 mt-1">
                Transaction ID: {payment._id}
              </p>
            </div>
            <button
              onClick={onClose}
              className="w-10 h-10 rounded-full flex items-center justify-center transition-all"
            >
              <FiXCircle className="w-6 h-6 text-primary" />
            </button>
          </div>
        </div>

        {/* Modal Body */}
        <div className="p-6 space-y-6">
          {/* Payment Information */}
          <Section title="Payment Information" icon={<FiDollarSign />}>
            {/* PRIMARY PRICING */}
            <div className="mb-4">
              <h4 className="text-sm font-semibold text-gray-700 mb-3">
                Pricing Breakdown
              </h4>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                <PaymentDetailBox
                  label="Original Price"
                  value={`${paymentDetails.symbol || "$"}${formatNumber(
                    paymentDetails.packageOriginalPrice || 0
                  )}`}
                  color="emerald"
                />
                <PaymentDetailBox
                  label="Package Cost"
                  value={`${paymentDetails.symbol || "$"}${formatNumber(
                    paymentDetails.packageCost || 0
                  )}`}
                  color="emerald"
                />
                <PaymentDetailBox
                  label="Amount Paid"
                  value={`${paymentDetails.symbol || "$"}${formatNumber(
                    paymentDetails.amountPaid || 0
                  )}`}
                  color="emerald"
                />
              </div>
            </div>

            {/* DISCOUNTS & CREDITS */}
            <div className="mb-4">
              <h4 className="text-sm font-semibold text-gray-700 mb-3">
                Discounts & Credits
              </h4>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4 bg-orange-50 rounded-lg border border-orange-200">
                {paymentDetails.packageDiscount > 0 && (
                  <PaymentDetailBox
                    label={`Discount ${paymentDetails.packageDiscount}%`}
                    value={`-${paymentDetails.symbol || "$"}${formatNumber(
                      paymentDetails.packageDiscountAmount || 0
                    )}`}
                    color="orange"
                  />
                )}
                {paymentDetails.proratedCreditFull > 0 && (
                  <PaymentDetailBox
                    label="Credit (Full)"
                    value={`${
                      paymentDetails.symbol || "$"
                    }${paymentDetails.proratedCreditFull?.toFixed(2)}`}
                    color="orange"
                  />
                )}
                {paymentDetails.proratedCreditApplied > 0 && (
                  <PaymentDetailBox
                    label="Credit Applied"
                    value={`-${
                      paymentDetails.symbol || "$"
                    }${paymentDetails.proratedCreditApplied?.toFixed(2)}`}
                    color="orange"
                  />
                )}
                {paymentDetails.proratedCreditLost > 0 && (
                  <PaymentDetailBox
                    label="Credit Lost (Profit)"
                    value={`${
                      paymentDetails.symbol || "$"
                    }${paymentDetails.proratedCreditLost?.toFixed(2)}`}
                    color="red"
                  />
                )}
              </div>
            </div>

            {/* TRANSACTION DETAILS */}
            <div className="mb-4">
              <h4 className="text-sm font-semibold text-gray-700 mb-3">
                Transaction Fees (INR)
              </h4>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3 p-4 bg-purple-50 rounded-lg border border-purple-200">
                {paymentDetails.amountDue !== undefined && (
                  <PaymentDetailBox
                    label="Amount Due"
                    value={`${paymentDetails.symbol || "$"}${formatNumber(
                      paymentDetails.amountDue
                    )}`}
                    color="purple"
                  />
                )}
                {paymentDetails.fee > 0 && (
                  <PaymentDetailBox
                    label="Razorpay Fee"
                    value={`₹${(paymentDetails.fee / 100)?.toFixed(2)}`}
                    color="purple"
                  />
                )}
                {paymentDetails.tax > 0 && (
                  <PaymentDetailBox
                    label="GST (18%)"
                    value={`₹${(paymentDetails.tax / 100)?.toFixed(2)}`}
                    color="purple"
                  />
                )}
              </div>
            </div>

            {/* OTHER INFO */}
            <InfoGrid>
              {paymentDetails.paymentStatus && (
                <InfoItem
                  label="Payment Status"
                  value={
                    <span
                      className={`px-3 py-1 rounded-full text-xs font-semibold ${
                        getPaymentStatusConfig(paymentDetails.paymentStatus)
                          .badgeColor
                      }`}
                    >
                      {paymentDetails.paymentStatus}
                    </span>
                  }
                />
              )}
              {paymentDetails.paymentMethod && (
                <InfoItem
                  label="Payment Method"
                  value={paymentDetails.paymentMethod.toUpperCase()}
                />
              )}
              {paymentDetails.currency && (
                <InfoItem
                  label="Currency"
                  value={`${paymentDetails.currency} (${
                    paymentDetails.symbol || "$"
                  })`}
                />
              )}
              {paymentDetails.paymentDate && (
                <InfoItem
                  label="Payment Date"
                  value={formatFullDate(paymentDetails.paymentDate)}
                />
              )}
              {paymentDetails.cardId && (
                <InfoItem
                  label="Card ID"
                  value={paymentDetails.cardId}
                  copyable
                />
              )}
              {paymentDetails.acquirerData?.auth_code && (
                <InfoItem
                  label="Auth Code"
                  value={paymentDetails.acquirerData.auth_code}
                />
              )}
            </InfoGrid>
          </Section>

          {/* Razorpay Details */}
          <Section title="Razorpay Details" icon={<FiFileText />}>
            <InfoGrid>
              <InfoItem
                label="Order ID"
                value={paymentDetails.razorpayOrderId || "N/A"}
                copyable
              />
              <InfoItem
                label="Payment ID"
                value={paymentDetails.razorpayPaymentId || "N/A"}
                copyable
              />
              <InfoItem
                label="Invoice Number"
                value={paymentDetails.invoiceNumber || "N/A"}
              />
              <InfoItem
                label="Invoice URL"
                value={
                  paymentDetails.invoiceUrl ? (
                    <a
                      href={paymentDetails.invoiceUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-[#343148] hover:text-[#D7C39D] underline flex items-center gap-1"
                    >
                      Download <FiDownload className="w-3 h-3" />
                    </a>
                  ) : (
                    "N/A"
                  )
                }
              />
            </InfoGrid>
            {paymentDetails.failureReason && (
              <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                <p className="text-xs font-semibold text-red-700 mb-1">
                  Failure Reason:
                </p>
                <p className="text-sm text-red-600">
                  {paymentDetails.failureReason}
                </p>
              </div>
            )}
          </Section>

          {/* Package Information */}
          <Section title="Package Information" icon={<FiPackage />}>
            <InfoGrid>
              <InfoItem
                label="Package Name"
                value={
                  packageId?.packageName || packageDetails?.packageName || "N/A"
                }
              />
              <InfoItem
                label="Action Type"
                value={
                  <span
                    className={`px-3 py-1 rounded-full text-xs font-semibold ${
                      getActionConfig(payment.action).badgeColor
                    }`}
                  >
                    {payment.action.toUpperCase()}
                  </span>
                }
              />
              <InfoItem
                label="Start Date"
                value={
                  payment.startDate ? formatFullDate(payment.startDate) : "N/A"
                }
              />
              <InfoItem
                label="End Date"
                value={
                  payment.endDate ? formatFullDate(payment.endDate) : "N/A"
                }
              />
              <InfoItem
                label="Validity"
                value={`${calculateDuration(
                  payment.startDate,
                  payment.endDate
                )} days`}
              />
              <InfoItem
                label="Is Active"
                value={
                  payment.isActive ? (
                    <FiCheckCircle className="w-5 h-5 text-green-600" />
                  ) : (
                    <FiXCircle className="w-5 h-5 text-red-600" />
                  )
                }
              />
            </InfoGrid>
            {previousPackageId && (
              <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="text-xs font-semibold text-blue-700">
                  Previous Package: {previousPackageId.packageName}
                </p>
              </div>
            )}
          </Section>

          {/* Package Details (Features) */}
          {packageDetails && (
            <Section title="Package Features" icon={<FiLayers />}>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                <FeatureItem
                  label="Total Storage"
                  value={`${packageDetails.totalPhotoMB} MB`}
                />
                <FeatureItem
                  label="Event Limit"
                  value={packageDetails.eventLimit}
                />
                <FeatureItem
                  label="Images per Album"
                  value={packageDetails.imageLimitPerAlbum}
                />
                <FeatureItem
                  label="Max Photo Size"
                  value={`${packageDetails.maximumPhotoSize} MB`}
                />
                <FeatureItem
                  label="Guests per Event"
                  value={packageDetails.totalGuestsAllowPerEvent}
                />
                <FeatureItem
                  label="Face Recognition"
                  enabled={packageDetails.faceRecognition}
                />
                <FeatureItem
                  label="Custom Themes"
                  enabled={packageDetails.customisableEventThemes}
                />
                <FeatureItem
                  label="Guest Uploads"
                  enabled={packageDetails.guestUploads}
                />
                <FeatureItem
                  label="Bulk Download"
                  enabled={packageDetails.bulkDownload}
                />
                <FeatureItem
                  label="Analytics"
                  enabled={packageDetails.analytics}
                />
                <FeatureItem label="QR Code" enabled={packageDetails.qrCode} />
                <FeatureItem
                  label="Watermark"
                  enabled={packageDetails.watermark}
                />
              </div>
            </Section>
          )}

          {/* Usage at Action */}
          {payment.usageAtAction && (
            <Section title="Usage at Transaction Time" icon={<FiDatabase />}>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                <UsageCard
                  icon={<FiCalendar />}
                  label="Events"
                  value={payment.usageAtAction.totalEvents || 0}
                  color="blue"
                />
                <UsageCard
                  icon={<FiLayers />}
                  label="Albums"
                  value={payment.usageAtAction.totalAlbums || 0}
                  color="purple"
                />
                <UsageCard
                  icon={<FiImage />}
                  label="Photos"
                  value={formatNumber(payment.usageAtAction.totalPhotos || 0)}
                  color="green"
                />
                <UsageCard
                  icon={<FiDatabase />}
                  label="Storage"
                  value={`${(
                    (payment.usageAtAction.totalMBUsed || 0) / 1024
                  ).toFixed(2)} GB`}
                  color="orange"
                />
                <UsageCard
                  icon={<FiUsers />}
                  label="Guests"
                  value={payment.usageAtAction.activeGuests || 0}
                  color="pink"
                />
              </div>
            </Section>
          )}

          {/* Notes */}
          {(payment.notes || payment.systemNotes) && (
            <Section title="Notes" icon={<FiFileText />}>
              {payment.notes && (
                <div className="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-xs font-semibold text-blue-700 mb-1">
                    User Notes:
                  </p>
                  <p className="text-sm text-blue-900">{payment.notes}</p>
                </div>
              )}
              {payment.systemNotes && (
                <div className="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                  <p className="text-xs font-semibold text-gray-700 mb-1">
                    System Notes:
                  </p>
                  <p className="text-sm text-gray-900">{payment.systemNotes}</p>
                </div>
              )}
            </Section>
          )}

          {/* Timestamps */}
          <Section title="Timestamps" icon={<FiClock />}>
            <InfoGrid>
              <InfoItem
                label="Created At"
                value={formatFullDate(payment.createdAt)}
              />
              <InfoItem
                label="Updated At"
                value={formatFullDate(payment.updatedAt)}
              />
            </InfoGrid>
          </Section>
        </div>

        {/* Modal Footer */}
        <div className="sticky bottom-0 bg-gray-50 p-4 rounded-b-2xl border-t border-gray-200">
          <button
            onClick={onClose}
            className="w-full py-3 bg-[#343148] text-white rounded-lg hover:bg-[#D7C39D] transition-colors font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

const Section = ({ title, icon, children }) => (
  <div className="border border-gray-200 rounded-xl p-5 bg-gray-50">
    <div className="flex items-center gap-2 mb-4">
      <div className="text-[#343148] text-lg">{icon}</div>
      <h3 className="text-base font-semibold text-[#343148]">{title}</h3>
    </div>
    {children}
  </div>
);

const InfoGrid = ({ children }) => (
  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{children}</div>
);

const InfoItem = ({ label, value, highlight, copyable }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    if (typeof value === "string") {
      navigator.clipboard.writeText(value);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  const highlightColors = {
    green: "text-green-600",
    blue: "text-[#343148]",
  };

  return (
    <div className="flex flex-col">
      <p className="text-xs text-gray-500 font-medium mb-1">{label}</p>
      <div className="flex items-center gap-2">
        <p
          className={`text-sm font-semibold ${
            highlight ? highlightColors[highlight] : "text-gray-900"
          }`}
        >
          {value}
        </p>
        {copyable && (
          <button
            onClick={handleCopy}
            className="text-[#343148] hover:text-[#D7C39D] transition-colors"
            title="Copy to clipboard"
          >
            {copied ? (
              <FiCheckCircle className="w-4 h-4 text-green-600" />
            ) : (
              <FiFileText className="w-4 h-4" />
            )}
          </button>
        )}
      </div>
    </div>
  );
};

const FeatureItem = ({ label, value, enabled }) => (
  <div className="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200">
    <span className="text-xs text-gray-700">{label}</span>
    {enabled !== undefined ? (
      enabled ? (
        <FiCheckCircle className="w-4 h-4 text-green-600" />
      ) : (
        <FiXCircle className="w-4 h-4 text-red-600" />
      )
    ) : (
      <span className="text-xs font-semibold text-[#343148]">{value}</span>
    )}
  </div>
);

const UsageCard = ({ icon, label, value, color }) => {
  const colorClasses = {
    blue: "from-blue-500 to-blue-600",
    purple: "from-purple-500 to-purple-600",
    green: "from-green-500 to-green-600",
    orange: "from-orange-500 to-orange-600",
    pink: "from-pink-500 to-pink-600",
  };

  return (
    <div className="bg-white rounded-lg p-4 border border-gray-200 text-center">
      <div
        className={`w-10 h-10 rounded-lg bg-gradient-to-br ${colorClasses[color]} flex items-center justify-center text-white mx-auto mb-2`}
      >
        {icon}
      </div>
      <p className="text-xs text-gray-600 mb-1">{label}</p>
      <p className="text-lg font-bold text-[#343148]">{value}</p>
    </div>
  );
};

const ErrorState = ({ message }) => (
  <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
    <div className="text-center p-8 max-w-md bg-white rounded-2xl shadow-lg border">
      <FiAlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-4" />
      <h3 className="text-lg font-bold text-gray-900 mb-4">{message}</h3>
      <button
        onClick={() => window.history.back()}
        className="px-6 py-3 bg-[#343148] text-white font-semibold rounded-lg hover:bg-[#D7C39D] hover:text-[#343148] transition-all"
      >
        ← Go Back
      </button>
    </div>
  </div>
);
// ============ UTILITY FUNCTIONS ============

const getPaymentStatusConfig = (status) => {
  const configs = {
    success: {
      icon: <FiCheckCircle />,
      textColor: "text-green-600",
      badgeColor: "bg-green-100 text-green-800",
    },
    failed: {
      icon: <FiXCircle />,
      textColor: "text-red-600",
      badgeColor: "bg-red-100 text-red-800",
    },
    pending: {
      icon: <FiClock />,
      textColor: "text-orange-600",
      badgeColor: "bg-orange-100 text-orange-800",
    },
  };
  return configs[status] || configs.pending;
};

const getActionConfig = (action) => {
  const configs = {
    // Trial Actions
    trial_started: {
      icon: <FiClock className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-gray-500 to-gray-600",
      badgeColor: "bg-gray-100 text-gray-800",
      label: "Trial Started",
    },
    trial_upgraded: {
      icon: <FiTrendingUp className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-purple-500 to-purple-600",
      badgeColor: "bg-purple-100 text-purple-800",
      label: "Trial Upgraded",
    },
    trial_expired: {
      icon: <FiXCircle className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-red-500 to-red-600",
      badgeColor: "bg-red-100 text-red-800",
      label: "Trial Expired",
    },

    // Subscription Actions
    subscription_started: {
      icon: <FiShoppingCart className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-blue-500 to-blue-600",
      badgeColor: "bg-blue-100 text-blue-800",
      label: "Subscription Started",
    },
    subscription_changed: {
      icon: <FiRefreshCw className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-indigo-500 to-indigo-600",
      badgeColor: "bg-indigo-100 text-indigo-800",
      label: "Subscription Changed",
    },
    subscription_renewed: {
      icon: <FiRefreshCw className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-green-500 to-green-600",
      badgeColor: "bg-green-100 text-green-800",
      label: "Subscription Renewed",
    },
    subscription_expired: {
      icon: <FiXCircle className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-red-500 to-red-600",
      badgeColor: "bg-red-100 text-red-800",
      label: "Subscription Expired",
    },

    // Upgrade/Renewal Actions
    upgrade_initiated: {
      icon: <FiTrendingUp className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-purple-500 to-purple-600",
      badgeColor: "bg-purple-100 text-purple-800",
      label: "Upgrade Initiated",
    },
    renewal_initiated: {
      icon: <FiClock className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-green-500 to-green-600",
      badgeColor: "bg-green-100 text-green-800",
      label: "Renewal Initiated",
    },
  };

  return (
    configs[action] || {
      icon: <FiFileText className="w-6 h-6" />,
      bgColor: "bg-gradient-to-br from-gray-500 to-gray-600",
      badgeColor: "bg-gray-100 text-gray-800",
      label: action.replace(/_/g, " ").toUpperCase(),
    }
  );
};

const formatNumber = (num) => {
  if (!num) return "0";
  return new Intl.NumberFormat("en-IN").format(num);
};

const formatDate = (date) => {
  return new Date(date).toLocaleDateString("en-IN", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
};

const formatTime = (date) => {
  return new Date(date).toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit",
  });
};

const formatFullDate = (date) => {
  return new Date(date).toLocaleDateString("en-IN", {
    day: "numeric",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const calculateDuration = (startDate, endDate) => {
  if (!startDate || !endDate) return 0;
  const start = new Date(startDate);
  const end = new Date(endDate);
  const diffTime = Math.abs(end - start);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
};

const PaymentDetailBox = ({ label, value, color = "emerald" }) => {
  const colorClasses = {
    emerald: "text-emerald-700 font-black",
    orange: "text-orange-700 font-black",
    purple: "text-purple-700 font-black",
    red: "text-red-700 font-black",
  };

  return (
    <div className="bg-white rounded-lg p-3 shadow-sm">
      <div className="text-xs text-gray-600 uppercase tracking-wide font-medium mb-1">
        {label}
      </div>
      <div className={`text-lg ${colorClasses[color]}`}>{value}</div>
    </div>
  );
};

// ============ CLIENT-SIDE STATS CALCULATION ============
const calculateStats = (timeline) => {
  // Flatten all payments from timeline
  const allPayments = timeline.flatMap((period) => period.payments);

  // Filter by payment status
  const completedPayments = allPayments.filter(
    (p) => p.paymentDetails.paymentStatus === "completed"
  );
  const failedPayments = allPayments.filter(
    (p) => p.paymentDetails.paymentStatus === "failed"
  );
  const pendingPayments = allPayments.filter(
    (p) => p.paymentDetails.paymentStatus === "pending"
  );

  // Separate by currency
  const inrPayments = completedPayments.filter(
    (p) => p.paymentDetails.currency === "INR"
  );
  const usdPayments = completedPayments.filter(
    (p) => p.paymentDetails.currency === "USD"
  );

  // Calculate INR metrics
  const inrStats = {
    totalAmountPaid: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.amountPaid || 0),
      0
    ),
    totalOriginalAmount: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.packageOriginalPrice || 0),
      0
    ),
    totalDiscounts: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.packageDiscountAmount || 0),
      0
    ),
    totalCreditApplied: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.proratedCreditApplied || 0),
      0
    ),
    totalCreditLost: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.proratedCreditLost || 0),
      0
    ),
    totalRazorpayFees: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.fee || 0) / 100,
      0
    ),
    totalRazorpayTax: inrPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.tax || 0) / 100,
      0
    ),
    count: inrPayments.length,
  };

  // Calculate USD metrics
  const usdStats = {
    totalAmountPaid: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.amountPaid || 0),
      0
    ),
    totalOriginalAmount: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.packageOriginalPrice || 0),
      0
    ),
    totalDiscounts: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.packageDiscountAmount || 0),
      0
    ),
    totalCreditApplied: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.proratedCreditApplied || 0),
      0
    ),
    totalCreditLost: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.proratedCreditLost || 0),
      0
    ),
    totalRazorpayFees: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.fee || 0) / 100,
      0
    ),
    totalRazorpayTax: usdPayments.reduce(
      (sum, p) => sum + (p.paymentDetails.tax || 0) / 100,
      0
    ),
    count: usdPayments.length,
  };

  return {
    totalTransactions: allPayments.length,
    successfulPayments: completedPayments.length,
    failedPayments: failedPayments.length,
    pendingPayments: pendingPayments.length,
    totalProfit: inrStats.totalCreditLost + usdStats.totalCreditLost,
    INR: inrStats,
    USD: usdStats,
  };
};









/* client package payment-history  */
const getClientPackagePaymentHistory = async (req, res, next) => {
  try {
    const { clientId } = req.params;

    // Fetch ALL payment history (no limit, no pagination)
    const paymentHistory = await EnterprisePackageHistory.find({
      enterpriseClientId: clientId,
    })
      .populate("packageId", "packageName cost discount validityInDays")
      .populate("previousPackageId", "packageName")
      .sort({ createdAt: -1 }); // Latest first

    // Group by action type
    const actionBreakdown = {
      trial: paymentHistory.filter((p) =>
        [
          SubscriptionAction.TRIAL_STARTED,
          SubscriptionAction.TRIAL_EXPIRED,
        ].includes(p.action),
      ).length,

      purchase: paymentHistory.filter(
        (p) => p.action === SubscriptionAction.SUBSCRIPTION_STARTED,
      ).length,

      upgrade: paymentHistory.filter((p) =>
        [
          SubscriptionAction.UPGRADE_INITIATED,
          SubscriptionAction.TRIAL_UPGRADED,
          SubscriptionAction.SUBSCRIPTION_CHANGED,
        ].includes(p.action),
      ).length,

      renewal: paymentHistory.filter((p) =>
        [
          SubscriptionAction.RENEWAL_INITIATED,
          SubscriptionAction.SUBSCRIPTION_RENEWED,
        ].includes(p.action),
      ).length,

      expired: paymentHistory.filter((p) =>
        [
          SubscriptionAction.SUBSCRIPTION_EXPIRED,
          SubscriptionAction.TRIAL_EXPIRED,
        ].includes(p.action),
      ).length,
    };

    // Group by year and month for timeline
    const timelineData = paymentHistory.reduce((acc, payment) => {
      const date = new Date(payment.createdAt);
      const year = date.getFullYear();
      const month = date.toLocaleString("default", { month: "long" });
      const key = `${year}-${month}`;

      if (!acc[key]) {
        acc[key] = {
          year,
          month,
          payments: [],
        };
      }
      acc[key].payments.push(payment);
      return acc;
    }, {});

    return await jsonOne(res, HTTP.SUCCESS, {
      actionBreakdown,
      timeline: Object.values(timelineData),
      totalRecords: paymentHistory.length,
    });
  } catch (error) {
    next(error);
  }
};
