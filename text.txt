"use client";
import LoadingSkeleton from "@/src/loader/LoadingSkeleton";
import { fetchEnterpriseClientCurrentPackage } from "@/src/redux/features/enterprise/client/clientThunks";
import { formatDate } from "@/src/utils";
import { useParams } from "next/navigation";
import { useEffect } from "react";
import {
  FiAlertTriangle,
  FiCalendar,
  FiCheckCircle,
  FiClock,
  FiCreditCard,
  FiDatabase,
  FiImage,
  FiPackage,
  FiTrendingUp,
  FiXCircle,
} from "react-icons/fi";
import { useDispatch, useSelector } from "react-redux";

function CurrentPackage() {
  const dispatch = useDispatch();
  const { id } = useParams();
  const { clientCurrentPackage, loading } = useSelector(
    (state) => state.enterpriseClient
  );

  useEffect(() => {
    if (id && !clientCurrentPackage) {
      dispatch(fetchEnterpriseClientCurrentPackage({ id }));
    }
  }, [dispatch, id]);

  if (loading) return <LoadingSkeleton />;
  if (!clientCurrentPackage?.package)
    return <ErrorState message="No package data" />;

  const pkg = clientCurrentPackage.package;
  const limits = pkg.packageId || {};
  const payment = pkg.paymentDetails || {};

  return (
    <div className="min-h-screen">
      <div className="max-w-[1600px] mx-auto">
        {/* Compact Header with Status */}
        <div
          className={`mb-6 p-6 rounded-2xl shadow-lg border-2 ${
            pkg.isExpired
              ? "bg-gradient-to-r from-red-500 to-red-600 border-red-400"
              : "bg-gradient-to-r from-[#343148] to-[#D7C39D] border-[#D7C39D]"
          }`}
        >
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                <FiPackage className="w-7 h-7 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-white">
                  {limits.packageName || "Package"}
                </h1>
                <div className="flex items-center gap-3 mt-1">
                  <span className="px-3 py-1 bg-white/20 rounded-full text-xs font-semibold text-white">
                    {pkg.status}
                  </span>
                  {pkg.isTrial && (
                    <span className="px-3 py-1 bg-yellow-400 rounded-full text-xs font-semibold text-gray-900">
                      Trial
                    </span>
                  )}
                </div>
              </div>
            </div>
            <div className="flex items-center gap-6">
              <div className="text-center">
                <div
                  className={`text-4xl font-black text-white ${
                    pkg.daysLeft === 0 ? "animate-pulse" : ""
                  }`}
                >
                  {pkg.daysLeft}
                </div>
                <div className="text-sm font-semibold text-white/80">
                  Days Left
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm text-white/70">Valid Till</div>
                <div className="text-base font-bold text-white">
                  {formatDate(pkg.endDate).date}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Main 2-Column Grid - Compact */}
        <div className="grid grid-cols-1 xl:grid-cols-5 gap-6">
          {/* Left: Package + Payment */}
          <div className="xl:col-span-3 space-y-6">
            {/* Package Info */}
            <div className="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-5 py-3 border-b border-gray-200">
                <h2 className="text-base font-bold text-[#343148] flex items-center gap-2">
                  <FiPackage className="w-5 h-5 text-[#D7C39D]" />
                  Package Details
                </h2>
              </div>
              <div className="p-5">
                <table className="w-full text-sm">
                  <tbody>
                    {renderDynamicRow(
                      "Start Date",
                      formatDate(pkg.startDate).date,
                      FiCalendar
                    )}
                    {renderDynamicRow(
                      "End Date",
                      formatDate(pkg.endDate).date,
                      FiCalendar
                    )}
                    {limits.validityInDays &&
                      renderDynamicRow(
                        "Validity",
                        `${limits.validityInDays} Days`,
                        FiClock
                      )}
                  </tbody>
                </table>
              </div>
            </div>

            {/* ✅ COMPLETE PAYMENT BREAKDOWN - ADMIN VIEW */}
            <div className="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-5 py-3 border-b border-gray-200">
                <h2 className="text-base font-bold text-[#343148] flex items-center gap-2">
                  <FiCreditCard className="w-5 h-5 text-[#D7C39D]" />
                  Payment Details (Admin View)
                </h2>
              </div>
              <div className="p-5">
                {/* ✅ PRIMARY PRICING - Main amounts */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                  <PaymentDetail
                    label="Original Price"
                    value={`${payment.symbol}${payment.packageOriginalPrice}`}
                    highlight
                    color="emerald"
                  />
                  <PaymentDetail
                    label="Package Cost"
                    value={`${payment.symbol}${payment.packageCost}`}
                    highlight
                    color="emerald"
                  />
                  <PaymentDetail
                    label="Amount Paid"
                    value={`${payment.symbol}${payment.amountPaid}`}
                    highlight
                    color="emerald"
                  />
                </div>

                {/* ✅ DISCOUNTS & CREDITS */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                  {payment.packageDiscount > 0 && (
                    <PaymentDetail
                      label={`Discount ${payment.packageDiscount}%`}
                      value={`-${payment.symbol}${payment.packageDiscountAmount}`}
                      color="orange"
                    />
                  )}
                  {payment.proratedCreditFull > 0 && (
                    <PaymentDetail
                      label="Prorated Credit (Full)"
                      value={`${
                        payment.symbol
                      }${payment.proratedCreditFull?.toFixed(2)}`}
                      color="orange"
                    />
                  )}
                  {payment.proratedCreditApplied > 0 && (
                    <PaymentDetail
                      label="Credit Applied"
                      value={`-${
                        payment.symbol
                      }${payment.proratedCreditApplied?.toFixed(2)}`}
                      color="orange"
                    />
                  )}
                  {payment.proratedCreditLost > 0 && (
                    <PaymentDetail
                      label="Credit Lost"
                      value={`${
                        payment.symbol
                      }${payment.proratedCreditLost?.toFixed(2)}`}
                      color="red"
                    />
                  )}
                </div>

                {/* ✅ TRANSACTION DETAILS */}
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                  {payment.amountDue !== undefined && (
                    <PaymentDetail
                      label="Amount Due"
                      value={`${payment.symbol}${payment.amountDue}`}
                      color="purple"
                    />
                  )}
                  {payment.fee > 0 && (
                    <PaymentDetail
                      label="Transaction Fee (INR)"
                      value={`₹${(payment.fee / 100)?.toFixed(2)}`}
                      color="purple"
                    />
                  )}
                  {payment.tax > 0 && (
                    <PaymentDetail
                      label="GST (INR)"
                      value={`₹${(payment.tax / 100)?.toFixed(2)}`}
                      color="purple"
                    />
                  )}
                </div>

                {/* Payment Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {payment.paymentStatus && (
                    <InfoItem
                      label="Status"
                      value={
                        <span
                          className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${
                            payment.paymentStatus === "completed"
                              ? "bg-emerald-100 text-emerald-800"
                              : "bg-yellow-100 text-yellow-800"
                          }`}
                        >
                          {payment.paymentStatus}
                        </span>
                      }
                    />
                  )}
                  {payment.paymentMethod && (
                    <InfoItem
                      label="Method"
                      value={payment.paymentMethod.toUpperCase()}
                    />
                  )}
                  {payment.currency && (
                    <InfoItem
                      label="Currency"
                      value={`${payment.currency} (${payment.symbol})`}
                    />
                  )}
                  {payment.paymentDate && (
                    <InfoItem
                      label="Date"
                      value={formatDate(payment.paymentDate).date}
                    />
                  )}
                  {payment.razorpayOrderId && (
                    <InfoItem
                      label="Order ID"
                      value={payment.razorpayOrderId}
                      mono
                      truncate
                    />
                  )}
                  {payment.razorpayPaymentId && (
                    <InfoItem
                      label="Payment ID"
                      value={payment.razorpayPaymentId}
                      mono
                      truncate
                    />
                  )}
                  {payment.invoiceNumber && (
                    <InfoItem
                      label="Invoice"
                      value={`#${payment.invoiceNumber}`}
                    />
                  )}
                  {payment.cardId && (
                    <InfoItem
                      label="Card ID"
                      value={payment.cardId}
                      mono
                      truncate
                    />
                  )}
                  {payment.acquirerData?.auth_code && (
                    <InfoItem
                      label="Auth Code"
                      value={payment.acquirerData.auth_code}
                    />
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Right: Usage Stats */}
          <div className="xl:col-span-2 space-y-6">
            {/* Usage Summary */}
            <div className="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-5 py-3 border-b border-gray-200">
                <h2 className="text-base font-bold text-[#343148] flex items-center gap-2">
                  <FiTrendingUp className="w-5 h-5 text-[#D7C39D]" />
                  Usage Statistics
                </h2>
              </div>
              <div className="p-5 space-y-4">
                {pkg.eventsUsed !== undefined && limits.eventLimit && (
                  <UsageBar
                    label="Events"
                    used={pkg.eventsUsed}
                    limit={limits.eventLimit}
                    icon={FiCalendar}
                  />
                )}
                {pkg.storageUsed !== undefined && limits.totalPhotoMB && (
                  <UsageBar
                    label="Storage (MB)"
                    used={pkg.storageUsed}
                    limit={limits.totalPhotoMB}
                    icon={FiDatabase}
                  />
                )}
                {pkg.albumsUsed !== undefined && limits.imageLimitPerAlbum && (
                  <UsageBar
                    label="Albums"
                    used={pkg.albumsUsed}
                    limit={limits.imageLimitPerAlbum}
                    icon={FiImage}
                  />
                )}
                {pkg.photosUsed !== undefined && (
                  <UsageStat
                    label="Photos Uploaded"
                    value={pkg.photosUsed}
                    icon={FiImage}
                  />
                )}
                {pkg.eventsRemaining !== undefined && (
                  <UsageStat
                    label="Events Remaining"
                    value={pkg.eventsRemaining}
                    icon={FiCalendar}
                    color="green"
                  />
                )}
              </div>
            </div>

            {/* Features - Compact Grid */}
            <div className="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-5 py-3 border-b border-gray-200">
                <h2 className="text-base font-bold text-[#343148] flex items-center gap-2">
                  <FiCheckCircle className="w-5 h-5 text-[#D7C39D]" />
                  Features
                </h2>
              </div>
              <div className="p-5">
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  {Object.entries(limits)
                    .filter(([key, value]) => typeof value === "boolean")
                    .map(([key, enabled]) => (
                      <FeatureChip
                        key={key}
                        label={formatFeatureName(key)}
                        enabled={enabled}
                      />
                    ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ✅ NEW: Payment Detail Component
const PaymentDetail = ({
  label,
  value,
  highlight = false,
  color = "emerald",
}) => {
  const colorClasses = {
    emerald: "text-emerald-600",
    orange: "text-orange-600",
    purple: "text-purple-600",
    blue: "text-blue-600",
    red: "text-red-600",
  };

  return (
    <div className={`p-3 rounded-lg ${highlight ? "bg-white shadow-sm" : ""}`}>
      <div className="text-xs text-gray-600 uppercase tracking-wide font-medium">
        {label}
      </div>
      <div className={`text-lg font-black ${colorClasses[color]}`}>{value}</div>
    </div>
  );
};

// ============ HELPER COMPONENTS ============
const renderDynamicRow = (label, value, Icon) => {
  if (!value || value === "Invalid Date") return null;
  return (
    <tr className="border-b border-gray-100 last:border-0 hover:bg-gray-50">
      <td className="py-3 pr-4 text-gray-600 font-medium flex items-center gap-2">
        <Icon className="w-4 h-4 text-[#D7C39D]" />
        {label}
      </td>
      <td className="py-3 text-[#343148] font-semibold text-right">{value}</td>
    </tr>
  );
};

const InfoItem = ({ label, value, mono = false, truncate = false }) => (
  <div className="p-3 bg-gray-50 rounded-lg">
    <div className="text-xs text-gray-600 mb-1">{label}</div>
    <div
      className={`text-sm font-bold text-[#343148] ${
        mono ? "font-mono text-xs" : ""
      } ${truncate ? "truncate" : ""}`}
    >
      {value}
    </div>
  </div>
);

const UsageBar = ({ label, used, limit, icon: Icon }) => {
  const percentage = Math.min(100, Math.round((used / limit) * 100));
  const remaining = Math.max(0, limit - used);

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Icon className="w-4 h-4 text-[#343148]" />
          <span className="text-sm font-semibold text-[#343148]">{label}</span>
        </div>
        <div className="text-xs font-bold text-gray-600">
          {used.toLocaleString()} / {limit.toLocaleString()}
        </div>
      </div>
      <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
        <div
          className="h-full bg-gradient-to-r from-[#343148] to-[#D7C39D] rounded-full transition-all"
          style={{ width: `${percentage}%` }}
        />
      </div>
      <div className="flex justify-between text-xs text-gray-500">
        <span>{percentage}% used</span>
        <span>{remaining.toLocaleString()} left</span>
      </div>
    </div>
  );
};

const UsageStat = ({ label, value, icon: Icon, color = "blue" }) => {
  const colors = {
    blue: "bg-blue-50 text-blue-600",
    green: "bg-green-50 text-green-600",
    orange: "bg-orange-50 text-orange-600",
  };

  return (
    <div className={`p-3 rounded-lg ${colors[color]}`}>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Icon className="w-4 h-4" />
          <span className="text-sm font-semibold">{label}</span>
        </div>
        <span className="text-xl font-black">{value.toLocaleString()}</span>
      </div>
    </div>
  );
};

const FeatureChip = ({ label, enabled }) => (
  <div
    className={`px-2 py-1.5 rounded-lg text-xs font-semibold flex items-center gap-1 ${
      enabled
        ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
        : "bg-gray-100 text-gray-500 border border-gray-200"
    }`}
  >
    {enabled ? (
      <FiCheckCircle className="w-3 h-3" />
    ) : (
      <FiXCircle className="w-3 h-3" />
    )}
    <span className="truncate">{label}</span>
  </div>
);

const ErrorState = ({ message }) => (
  <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
    <div className="text-center p-8 max-w-md bg-white rounded-2xl shadow-lg border">
      <FiAlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-4" />
      <h3 className="text-lg font-bold text-gray-900 mb-4">{message}</h3>
      <button
        onClick={() => window.history.back()}
        className="px-6 py-3 bg-[#343148] text-white font-semibold rounded-lg hover:bg-[#D7C39D] hover:text-[#343148] transition-all"
      >
        ← Go Back
      </button>
    </div>
  </div>
);

const formatFeatureName = (key) => {
  return key
    .replace(/([A-Z])/g, " $1")
    .replace(/^./, (str) => str.toUpperCase())
    .trim();
};

export default CurrentPackage;





/*** Get Client Current Package ***/
const getClientCurrentPackage = async (req, res, next) => {
  try {
    const { clientId } = req.params;

    const client = await EnterpriseClient.exists({ _id: clientId });

    if (!client) {
      return throwHttpError(
        "bad_request",
        constants.client.notFound,
        HTTP.NOT_FOUND
      );
    }

    // Current Package (most recent active or latest)
    const latestPackage = await EnterpriseClientPackage.findOne({
      enterpriseClientId: clientId,
    })
      .populate("packageId")
      .lean();

    // Usage from CLIENT'S EVENTS
    const usageStats = await EnterpriseClientEvent.aggregate([
      {
        $match: {
          enterpriseClientId: new mongoose.Types.ObjectId(clientId),
          deletedAt: null,
        },
      },
      {
        $group: {
          _id: null,
          totalEvents: { $sum: 1 },
          totalAlbums: { $sum: "$totalAlbums" },
          totalPhotos: { $sum: "$totalPhotos" },
          totalMBUsed: { $sum: "$totalMBUsed" },
        },
      },
    ]);

    const now = new Date();
    const isExpired = latestPackage && new Date(latestPackage.endDate) < now;
    const daysLeft = latestPackage
      ? Math.max(
          0,
          Math.ceil(
            (new Date(latestPackage.endDate) - now) / (24 * 60 * 60 * 1000)
          )
        )
      : 0;

    // Package limits from packageId
    const limits = latestPackage?.packageId || {};

    return await jsonOne(res, HTTP.SUCCESS, {
      package: {
        ...latestPackage,
        isExpired,
        daysLeft,
        status: isExpired
          ? "Expired"
          : latestPackage?.isActive
          ? "Active"
          : "Inactive",
        storageUsed: usageStats[0]?.totalMBUsed || 0,
        storageLimit: limits.totalPhotoMB || 0,
        storagePercentage: limits.totalPhotoMB
          ? Math.min(
              100,
              Math.round(
                ((usageStats[0]?.totalMBUsed || 0) / limits.totalPhotoMB) * 100
              )
            )
          : 0,
        eventsUsed: usageStats[0]?.totalEvents || 0,
        eventsRemaining: limits.eventLimit
          ? limits.eventLimit - (usageStats[0]?.totalEvents || 0)
          : 0,
        albumsUsed: usageStats[0]?.totalAlbums || 0,
        photosUsed: usageStats[0]?.totalPhotos || 0,
        paymentDetails: latestPackage?.paymentDetails || {},
      },
    });
  } catch (error) {
    next(error);
  }
};
