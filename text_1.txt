"use client";
import { usePathname, useRouter } from "next/navigation";
import {
  createContext,
  useCallback,
  useContext,
  useEffect,
  useState,
} from "react";
import { useDispatch, useSelector } from "react-redux";
import LoadingSkeleton from "../loader/LoadingSkeleton";
import { getIPInfo } from "../redux/features/auth/authThunks";
import { fetchClientPackage } from "../redux/features/package/packageThunks";
import { fetchUserProfile } from "../redux/features/user/userThunks";

const RootContext = createContext();

export const useRootData = () => {
  const context = useContext(RootContext);
  if (!context) throw new Error("useRootData must be used within RootProvider");
  return context;
};

export const  RootProvider = ({ children, cookie }) => {
  const dispatch = useDispatch();
  const router = useRouter();
  const pathname = usePathname();
  const { user } = useSelector((state) => state.user);
  const { onePackage } = useSelector((state) => state.package);
  const [isInitializing, setIsInitializing] = useState(true);
  const [ipInfo, setIpInfo] = useState(null);
  const [isRefreshingPackage, setIsRefreshingPackage] = useState(false);

  const isPackageExpired =
    onePackage?.endDate && new Date() > new Date(onePackage.endDate);

  const hasRequiredPhoneDetails = user?.phoneNumber && user?.countryCode;

  const isRouteAccessible = useCallback((path) => {
    const publicRoutes = ["/", "/upgrade-plan", "/contact-us"];
    const profileSetupRoutes = ["/my-account"];

    return (
      publicRoutes.some((route) => path === route || path.startsWith(route)) ||
      profileSetupRoutes.some(
        (route) => path === route || path.startsWith(route)
      )
    );
  }, []);

  const refreshPackage = useCallback(async () => {
    setIsRefreshingPackage(true);
    try {
      await dispatch(fetchClientPackage());
    } finally {
      setIsRefreshingPackage(false);
    }
  }, [dispatch]);

  // Redirect logic for missing phone details
  useEffect(() => {
    if (!isInitializing && cookie && user) {
      if (!hasRequiredPhoneDetails && !pathname.startsWith("/my-account")) {
        router.replace("/my-account?setup=phone");
        return;
      }

      if (isPackageExpired && !isRouteAccessible(pathname)) {
        router.replace("/");
      }
    }
  }, [
    pathname,
    isPackageExpired,
    isInitializing,
    router,
    isRouteAccessible,
    hasRequiredPhoneDetails,
    user,
    cookie,
  ]);

  useEffect(() => {
    const loadData = async () => {
      try {
        
        // Fetch IP info first
        try {
          const ipResponse = await getIPInfo();
          setIpInfo(ipResponse);
        } catch (error) {
          console.error("IP fetch error:", error);
        }
        setIsInitializing(true);

        if (cookie) {
          await Promise.all([
            dispatch(fetchUserProfile()),
            dispatch(fetchClientPackage()),
          ]);
        }
      } finally {
        setIsInitializing(false);
      }
    };
    loadData();
  }, [dispatch, cookie]);

  if (isInitializing && cookie) return <LoadingSkeleton />;

  return (
    <RootContext.Provider
      value={{
        ipInfo,
        user,
        onePackage,
        isPackageExpired,
        hasRequiredPhoneDetails,
        refreshPackage,
        isRefreshingPackage,
      }}
    >
      {children}
    </RootContext.Provider>
  );
};




"use client";
import Navbar from "@/src/components/layOut/NavBar/NavBar";
import SideBar from "@/src/components/layOut/Sidebar/SideBar";
import { useRootData } from "@/src/context/rootContext";
import dynamic from "next/dynamic";
import React, { useState } from "react";

const StorageWarningBanner = dynamic(() =>
  import("@/src/components/Package/StorageWarningBanner")
);

const PackageExpiryNotification = dynamic(() =>
  import("@/src/components/Package/PackageExpiryNotification")
);

export default function PhotoLayOut({ children }) {
  const { onePackage } = useRootData();
  const [showStorageWarning, setShowStorageWarning] = useState(true);
  const packageEndDate = onePackage?.endDate;
  const totalLimit = onePackage?.packageId?.totalPhotoMB || 0;
  const totalUsed = onePackage?.eventStatistics?.totalMBUsed || 0;
  const storagePercentage = (totalUsed / totalLimit) * 100;
  const shouldShowWarning = storagePercentage >= 80 && showStorageWarning;
  return (
    <main className="relative flex h-screen overflow-hidden bg-[#f4f4f4]">
      <div>
        <SideBar />
      </div>
      <div className="w-full xl:mx-5 mx-3 flex flex-col">
        <Navbar />
        <div className="flex flex-col gap-2 fixed top-4 right-0 md:right-4 z-50">
          <PackageExpiryNotification endDate={packageEndDate} />
          {shouldShowWarning && (
            <StorageWarningBanner
              storagePercentage={storagePercentage}
              totalUsed={totalUsed}
              totalLimit={totalLimit}
              onClose={() => setShowStorageWarning(false)}
              showProgressBar={true}
              showCloseButton={true}
            />
          )}
        </div>
        <section className="flex-1 bg-white p-4 rounded-t-[20px] overflow-hidden">
          {children}
        </section>
      </div>
    </main>
  );
}




import React from "react";
import { FiAlertTriangle, FiAlertCircle, FiX } from "react-icons/fi";

const StorageWarningBanner = ({
  storagePercentage,
  totalUsed,
  totalLimit,
  onClose,
  className = "",
  showProgressBar = true,
  showCloseButton = true,
}) => {
  const getWarningConfig = () => {
    if (storagePercentage >= 100) {
      return {
        icon: FiAlertCircle,
        title: "Storage Full",
        message: `You've used ${totalUsed.toFixed(
          1
        )}MB of ${totalLimit}MB. Please upgrade your package or delete some events to continue.`,
        bgColor: "bg-red-50",
        borderColor: "border-red-200",
        textColor: "text-red-800",
        iconColor: "text-red-600",
        progressColor: "bg-red-500",
        accentColor: "bg-red-500",
        buttonColor: "text-red-500 hover:text-red-700 hover:bg-red-100",
        alertLevel: "critical",
      };
    } else if (storagePercentage >= 90) {
      return {
        icon: FiAlertTriangle,
        title: "Storage Almost Full",
        message: `You've used ${totalUsed.toFixed(
          1
        )}MB of ${totalLimit}MB (${storagePercentage.toFixed(
          1
        )}%). Consider upgrading your package soon.`,
        bgColor: "bg-orange-50",
        borderColor: "border-orange-200",
        textColor: "text-orange-800",
        iconColor: "text-orange-600",
        progressColor: "bg-orange-500",
        accentColor: "bg-orange-500",
        buttonColor:
          "text-orange-500 hover:text-orange-700 hover:bg-orange-100",
        alertLevel: "warning",
      };
    } else if (storagePercentage >= 80) {
      return {
        icon: FiAlertTriangle,
        title: "Storage Warning",
        message: `You've used ${storagePercentage.toFixed(
          1
        )}% of your package storage. Plan for an upgrade to avoid running out of space.`,
        bgColor: "bg-yellow-50",
        borderColor: "border-yellow-200",
        textColor: "text-yellow-800",
        iconColor: "text-yellow-600",
        progressColor: "bg-yellow-500",
        accentColor: "bg-yellow-500",
        buttonColor:
          "text-yellow-500 hover:text-yellow-700 hover:bg-yellow-100",
        alertLevel: "notice",
      };
    }
    return null;
  };

  const config = getWarningConfig();
  if (!config) return null;

  return (
    <div
      className={`
        ${config.bgColor} 
        ${config.borderColor}
        w-full border rounded-lg shadow-sm
        transform transition-all duration-300 ease-out
        relative overflow-hidden
        ${className}
      `}
    >
      {/* Top accent bar */}
      <div className={`${config.accentColor} h-1 w-full`} />

      {/* Main banner content */}
      <div className="flex items-center justify-between p-2.5 sm:p-4">
        {/* Left side - Icon and message */}
        <div className="flex items-center space-x-3 flex-1">
          <div className={`${config.iconColor} flex-shrink-0`}>
            <config.icon className="w-5 h-5" />
          </div>

          <div className="flex-1">
            <div className="flex items-center space-x-2">
              <span className={`${config.textColor} font-semibold text-xs sm:text-sm`}>
                Package Storage:
              </span>
              <span className={`${config.textColor} text-xs sm:text-sm`}>
                {config.title}
              </span>
            </div>

            <p className={`${config.textColor} text-xs opacity-75 mt-1`}>
              {config.message}
            </p>

            {/* Storage info and progress bar inline for larger screens */}
            {showProgressBar && (
              <div className="mt-2">
                <div className="flex items-center space-x-3">
                  <div className="flex-1">
                    <div className="bg-white/60 rounded-full h-2 overflow-hidden">
                      <div
                        className={`h-2 rounded-full transition-all duration-500 ${config.progressColor}`}
                        style={{
                          width: `${Math.min(storagePercentage, 100)}%`,
                        }}
                      />
                    </div>
                  </div>
                  <div className="flex items-center sm:space-x-2 text-xs opacity-75 flex-shrink-0">
                    <span>{totalUsed.toFixed(1)} MB</span>
                    <span>/</span>
                    <span>{totalLimit} MB</span>
                    <span>({storagePercentage.toFixed(1)}%)</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Right side - Close button */}
        <div className="flex items-center sm:ml-4 fixed top-2 right-1">
          {showCloseButton && onClose && (
            <button
              onClick={onClose}
              className={`
                ${config.buttonColor}
                p-2 rounded-full transition-all duration-200
                hover:rotate-90 transform flex-shrink-0
              `}
              aria-label="Close warning"
            >
              <FiX className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>

      {/* Bottom progress bar (alternative to inline progress) */}
      {showProgressBar && (
        <div className="h-1 bg-gray-200">
          <div
            className={`h-full transition-all duration-500 ${config.progressColor}`}
            style={{ width: `${Math.min(storagePercentage, 100)}%` }}
          />
        </div>
      )}
    </div>
  );
};

export default StorageWarningBanner;



import { useEffect, useState } from "react";
import {
  FiAlertTriangle,
  FiX,
  FiClock,
  FiAlertCircle,
  FiCheckCircle,
  FiRefreshCw,
} from "react-icons/fi";

const PackageExpiryNotification = ({ endDate }) => {
  const [isVisible, setIsVisible] = useState(true);
  const [message, setMessage] = useState("");
  const [severity, setSeverity] = useState("info");
  const [isAnimating, setIsAnimating] = useState(false);

  useEffect(() => {
    const calculateExpiry = () => {
      const expiryDate = new Date(endDate);
      const today = new Date();
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays <= 0) {
        setMessage("Your package has expired!");
        setSeverity("error");
      } else if (diffDays <= 1) {
        setMessage("Package expires today!");
        setSeverity("error");
      } else if (diffDays <= 3) {
        setMessage(
          `Package expires in ${diffDays} day${diffDays > 1 ? "s" : ""}`
        );
        setSeverity("critical");
      } else if (diffDays <= 7) {
        setMessage(`Package expires in ${diffDays} days`);
        setSeverity("warning");
      } else {
        setIsVisible(false);
      }
    };

    calculateExpiry();
    const interval = setInterval(calculateExpiry, 24 * 60 * 60 * 1000);

    return () => clearInterval(interval);
  }, [endDate]);

  const handleClose = () => {
    setIsAnimating(true);
    setTimeout(() => {
      setIsVisible(false);
    }, 300);
  };

  if (!isVisible) return null;

  const getBannerStyles = () => {
    switch (severity) {
      case "error":
        return {
          container: "bg-red-50 border-red-200",
          icon: "text-red-600",
          text: "text-red-800",
          accent: "bg-red-500",
          button: "text-red-500 hover:text-red-700 hover:bg-red-100",
          progressBar: "bg-red-500",
        };
      case "critical":
        return {
          container: "bg-orange-50 border-orange-200",
          icon: "text-orange-600",
          text: "text-orange-800",
          accent: "bg-orange-500",
          button: "text-orange-500 hover:text-orange-700 hover:bg-orange-100",
          progressBar: "bg-orange-500",
        };
      case "warning":
        return {
          container: "bg-yellow-50 border-yellow-200",
          icon: "text-yellow-600",
          text: "text-yellow-800",
          accent: "bg-yellow-500",
          button: "text-yellow-500 hover:text-yellow-700 hover:bg-yellow-100",
          progressBar: "bg-yellow-500",
        };
      default:
        return {
          container: "bg-blue-50 border-blue-200",
          icon: "text-blue-600",
          text: "text-blue-800",
          accent: "bg-blue-500",
          button: "text-blue-500 hover:text-blue-700 hover:bg-blue-100",
          progressBar: "bg-blue-500",
        };
    }
  };

  const getIcon = () => {
    switch (severity) {
      case "error":
        return <FiAlertCircle className="w-5 h-5" />;
      case "critical":
        return <FiAlertTriangle className="w-5 h-5" />;
      case "warning":
        return <FiClock className="w-5 h-5" />;
      default:
        return <FiCheckCircle className="w-5 h-5" />;
    }
  };

  const getActionButton = () => {
    if (severity === "error" || severity === "critical") {
      return (
        <button
          className={`inline-flex items-center px-4 py-2 text-sm font-medium rounded-md transition-all duration-200 ${
            severity === "error"
              ? "bg-red-600 text-white hover:bg-red-700"
              : "bg-orange-600 text-white hover:bg-orange-700"
          }`}
        >
          <FiRefreshCw className="w-4 h-4 mr-2" />
          Renew Package
        </button>
      );
    }
    return null;
  };

  const styles = getBannerStyles();

  return (
    <div
      className={`
        ${styles.container}
        ${
          isAnimating
            ? "animate-pulse opacity-50 scale-95"
            : "animate-slideDown"
        }
        w-full border rounded-lg shadow-sm
        transform transition-all duration-300 ease-out
        relative overflow-hidden
      `}
    >
      {/* Top accent bar */}
      <div className={`${styles.accent} h-1 w-full`} />

      {/* Main banner content */}
      <div className="flex sm:flex-row flex-col items-center justify-between p-2.5 sm:p-4 gap-2">
        {/* Left side - Icon and message */}
        <div className="flex items-center space-x-3 flex-1">
          <div className={`${styles.icon} flex-shrink-0`}>{getIcon()}</div>

          <div className="flex-1">
            <div className="flex items-center space-x-2">
              <span className={`${styles.text} font-semibold text-xs sm:text-sm`}>
                Package Status:
              </span>
              <span className={`${styles.text} text-xs sm:text-sm`}>{message}</span>
            </div>

            {/* Additional message based on severity */}
            {(severity === "error" || severity === "critical") && (
              <p className={`${styles.text} text-xs opacity-75 mt-1`}>
                {severity === "error"
                  ? "Your package has expired. Renew now to continue using all features."
                  : "Your package is about to expire. Consider renewing to avoid service interruption."}
              </p>
            )}

            {severity === "warning" && (
              <p className={`${styles.text} text-xs opacity-75 mt-1`}>
                Remember to renew your package before it expires.
              </p>
            )}
          </div>
        </div>

        {/* Right side - Action button and close button */}
        <div className="flex items-center space-x-3 ml-4">
          {getActionButton()}

          <button
            onClick={handleClose}
            className={`
              ${styles.button}
              p-2 rounded-full transition-all duration-200
              hover:rotate-90 transform flex-shrink-0
            `}
            aria-label="Close notification"
          >
            <FiX className="w-4 h-4" />
          </button>
        </div>
      </div>

      {/* Progress bar at bottom */}
      <div className="h-1 bg-gray-200">
        <div
          className={`h-full transition-all duration-500 ${styles.progressBar}`}
          style={{
            width:
              severity === "error"
                ? "100%"
                : severity === "critical"
                ? "85%"
                : severity === "warning"
                ? "60%"
                : "30%",
          }}
        />
      </div>
    </div>
  );
};

export default PackageExpiryNotification;






